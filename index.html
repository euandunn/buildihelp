<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Subcontractor Management System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary-blue: #0671e3;
        }
        
        .primary-bg { background-color: var(--primary-blue); }
        .primary-text { color: var(--primary-blue); }
        .primary-border { border-color: var(--primary-blue); }
        
        .ios-card {
            background: white;
            border-radius: 16px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            border: 1px solid rgba(0, 0, 0, 0.05);
            min-height: 120px;
        }
        
        .ios-button {
            border-radius: 12px;
            font-weight: 600;
            transition: all 0.2s ease;
            border: none;
            cursor: pointer;
        }
        
        .ios-button:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(6, 113, 227, 0.3);
        }
        
        .ios-input {
            border-radius: 12px;
            border: 1px solid #e5e7eb;
            padding: 12px 16px;
            font-size: 16px;
            transition: all 0.2s ease;
        }
        
        .ios-input:focus {
            outline: none;
            border-color: var(--primary-blue);
            box-shadow: 0 0 0 3px rgba(6, 113, 227, 0.1);
        }
        
        .completed {
            text-decoration: line-through;
            opacity: 0.6;
        }
        
        .fade-in {
            animation: fadeIn 0.3s ease-in;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- Account Selection Screen -->
    <div id="accountSelection" class="min-h-screen flex items-center justify-center p-4">
        <div class="ios-card p-8 w-full max-w-md text-center fade-in">
            <h1 class="text-3xl font-bold primary-text mb-8">Select Account Type</h1>
            
            <div class="space-y-4">
                <button onclick="selectAccount('admin')" class="ios-button primary-bg text-white w-full py-4 text-lg">
                    Admin Account
                </button>
                
                <button onclick="showSubcontractorLogin()" class="ios-button bg-gray-100 text-gray-800 w-full py-4 text-lg">
                    Subcontractor Account
                </button>
                
                <button onclick="showCreateSubcontractor()" class="ios-button border-2 primary-border primary-text w-full py-4 text-lg">
                    Create Subcontractor Account
                </button>
            </div>
        </div>
    </div>

    <!-- Create Subcontractor Modal -->
    <div id="createSubcontractorModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
        <div class="ios-card p-6 w-full max-w-md">
            <h2 class="text-2xl font-bold primary-text mb-6">Create Subcontractor Account</h2>
            <div class="space-y-4">
                <input type="text" id="newSubcontractorName" placeholder="Subcontractor Name" class="ios-input w-full">
                <input type="text" id="newSubcontractorId" placeholder="Unique ID" class="ios-input w-full">
                <div class="flex space-x-3">
                    <button onclick="createSubcontractor()" class="ios-button primary-bg text-white flex-1 py-3">Create</button>
                    <button onclick="hideCreateSubcontractor()" class="ios-button bg-gray-200 text-gray-800 flex-1 py-3">Cancel</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Subcontractor Login Modal -->
    <div id="subcontractorLoginModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
        <div class="ios-card p-6 w-full max-w-md">
            <h2 class="text-2xl font-bold primary-text mb-6">Subcontractor Login</h2>
            <div class="space-y-4">
                <select id="subcontractorSelect" class="ios-input w-full">
                    <option value="">Select your account...</option>
                </select>
                <div class="flex space-x-3">
                    <button onclick="loginSubcontractor()" class="ios-button primary-bg text-white flex-1 py-3">Login</button>
                    <button onclick="hideSubcontractorLogin()" class="ios-button bg-gray-200 text-gray-800 flex-1 py-3">Cancel</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Dashboard -->
    <div id="dashboard" class="hidden min-h-screen">
        <!-- Header -->
        <header class="primary-bg text-white p-4 shadow-lg">
            <div class="flex justify-between items-center max-w-6xl mx-auto">
                <h1 class="text-2xl font-bold">Subcontractor Management</h1>
                <div class="flex items-center space-x-4">
                    <span id="currentUser" class="text-sm opacity-90"></span>
                    <button onclick="logout()" class="ios-button bg-white bg-opacity-20 text-white px-4 py-2 text-sm">Logout</button>
                </div>
            </div>
        </header>

        <!-- Navigation Tabs -->
        <nav class="bg-white shadow-sm border-b">
            <div class="max-w-6xl mx-auto px-4">
                <div class="flex space-x-8">
                    <button onclick="showTab('sites')" class="tab-button py-4 px-2 border-b-2 border-transparent hover:border-blue-300 transition-colors">Sites</button>
                    <button id="thisWeekTabButton" onclick="showTab('thisWeek')" class="tab-button py-4 px-2 border-b-2 border-transparent hover:border-blue-300 transition-colors hidden">This Week</button>
                    <button id="messagesTabButton" onclick="showTab('messages')" class="tab-button py-4 px-2 border-b-2 border-transparent hover:border-blue-300 transition-colors hidden">
                        Messages <span id="pendingCount" class="bg-red-500 text-white text-xs px-2 py-1 rounded-full ml-2 hidden">0</span>
                    </button>
                </div>
            </div>
        </nav>

        <!-- Sites Tab -->
        <div id="sitesTab" class="max-w-6xl mx-auto p-6">
            <!-- Admin Site Management -->
            <div id="adminSiteControls" class="hidden mb-8">
                <div class="ios-card p-6">
                    <h2 class="text-xl font-bold mb-4"><i class="fas fa-building mr-2 primary-text"></i>Site Management</h2>
                    <div class="flex space-x-4 mb-4">
                        <input type="text" id="newSiteName" placeholder="Site Name (e.g., Deer Park-Miller Homes)" class="ios-input flex-1">
                        <button onclick="addSite()" class="ios-button primary-bg text-white px-6 py-3">
                            <i class="fas fa-plus mr-2"></i>Add Site
                        </button>
                    </div>
                </div>
            </div>

            <!-- Sites List -->
            <div class="grid gap-6" id="sitesList">
                <!-- Sites will be populated here -->
            </div>
        </div>

        <!-- This Week Tab -->
        <div id="thisWeekTab" class="hidden max-w-6xl mx-auto p-6">
            <div class="ios-card p-6">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold">
                        <i class="fas fa-calendar-week mr-2 primary-text"></i>This Week's Work
                    </h2>
                    <button onclick="showDayWorkModal()" class="ios-button primary-bg text-white px-4 py-2">
                        <i class="fas fa-plus mr-2"></i>Add Day Work
                    </button>
                </div>
                
                <div id="weeklyWork" class="space-y-4 mb-6">
                    <!-- Weekly work items will appear here -->
                </div>
                
                <div class="border-t pt-4">
                    <div class="text-right">
                        <span class="text-lg font-bold primary-text">
                            <i class="fas fa-pound-sign mr-1"></i>Total This Week: £<span id="weeklyTotal">0.00</span>
                        </span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Messages Tab (Admin Only) -->
        <div id="messagesTab" class="hidden max-w-6xl mx-auto p-6">
            <div class="ios-card p-6">
                <h2 class="text-2xl font-bold mb-6">
                    <i class="fas fa-envelope mr-2 primary-text"></i>Day Work Requests
                </h2>
                
                <div id="dayWorkRequests" class="space-y-4">
                    <!-- Day work requests will appear here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Site Detail Modal -->
    <div id="siteDetailModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
        <div class="ios-card p-6 w-full max-w-4xl max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-6">
                <h2 id="siteDetailTitle" class="text-2xl font-bold primary-text"></h2>
                <button onclick="closeSiteDetail()" class="ios-button bg-gray-200 text-gray-800 px-4 py-2">Close</button>
            </div>
            
            <!-- Admin Controls -->
            <div id="siteAdminControls" class="hidden mb-6 space-y-4">
                <!-- House Types -->
                <div class="ios-card p-4">
                    <h3 class="font-bold mb-3">
                        <i class="fas fa-home-lg-alt mr-2 primary-text"></i>House Types
                    </h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                        <input type="text" id="houseTypeName" placeholder="House Type Name" class="ios-input">
                        <input type="number" id="firstFixPrice" placeholder="1st Fix Price" class="ios-input">
                        <input type="number" id="secondFixPrice" placeholder="2nd Fix Price" class="ios-input">
                        <input type="number" id="finalPrice" placeholder="Final Price" class="ios-input">
                    </div>
                    <button onclick="addHouseType()" class="ios-button primary-bg text-white px-4 py-2">
                        <i class="fas fa-plus mr-2"></i>Add House Type
                    </button>
                </div>
                
                <!-- Add Plot -->
                <div class="ios-card p-4">
                    <h3 class="font-bold mb-3">
                        <i class="fas fa-map-marked-alt mr-2 primary-text"></i>Add Plot
                    </h3>
                    <div class="flex space-x-4 mb-4">
                        <input type="text" id="plotNumber" placeholder="Plot Number" class="ios-input">
                        <select id="plotHouseType" class="ios-input">
                            <option value="">Select House Type</option>
                        </select>
                        <button onclick="addPlot()" class="ios-button primary-bg text-white px-4 py-2">
                            <i class="fas fa-plus mr-2"></i>Add Plot
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Plots Grid -->
            <div id="plotsGrid" class="grid gap-4">
                <!-- Plots will be populated here -->
            </div>
        </div>
    </div>

    <!-- Add Extras Modal -->
    <div id="addExtrasModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
        <div class="ios-card p-6 w-full max-w-md">
            <h2 class="text-xl font-bold primary-text mb-4">Add Extras</h2>
            <div class="space-y-4">
                <input type="text" id="extraDescription" placeholder="Extra Description (e.g., 8x downlights)" class="ios-input w-full">
                <input type="number" id="extraQuantity" placeholder="Quantity" class="ios-input w-full" value="1">
                <input type="number" id="extraPrice" placeholder="Price per item" class="ios-input w-full" value="7.50" step="0.01">
                <div class="flex space-x-3">
                    <button onclick="addExtra()" class="ios-button primary-bg text-white flex-1 py-3">Add Extra</button>
                    <button onclick="closeAddExtras()" class="ios-button bg-gray-200 text-gray-800 flex-1 py-3">Cancel</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Day Work Modal -->
    <div id="dayWorkModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
        <div class="ios-card p-6 w-full max-w-md">
            <h2 class="text-xl font-bold primary-text mb-4">Add Day Work</h2>
            <div class="space-y-4">
                <input type="number" id="dayWorkHours" placeholder="Hours worked" class="ios-input w-full" step="0.5">
                <input type="number" id="dayWorkRate" placeholder="Hourly rate (£)" class="ios-input w-full" step="0.01">
                <textarea id="dayWorkDescription" placeholder="Description of work" class="ios-input w-full h-20 resize-none"></textarea>
                <div class="flex space-x-3">
                    <button onclick="addDayWork()" class="ios-button primary-bg text-white flex-1 py-3">Submit</button>
                    <button onclick="closeDayWork()" class="ios-button bg-gray-200 text-gray-800 flex-1 py-3">Cancel</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global state
        let currentUser = null;
        let currentUserType = null;
        let currentSite = null;
        let currentPlot = null;
        
        // Data storage
        let sites = [
            {
                id: 1,
                name: 'Deer Park-Miller Homes',
                houseTypes: [
                    { id: 1, name: 'Fordwood', firstFix: 450, secondFix: 380, final: 120 }
                ],
                plots: [
                    { id: 1, number: '1', houseTypeId: 1, firstFixCompleted: false, secondFixCompleted: false, finalCompleted: false, extras: [], completedBy: {} }
                ]
            }
        ];
        
        let subcontractors = [];
        
        let weeklyWork = [];
        let dayWorkRequests = [];

        // Local Storage Functions
        function saveData() {
            const data = {
                sites: sites,
                subcontractors: subcontractors,
                weeklyWork: weeklyWork,
                dayWorkRequests: dayWorkRequests
            };
            localStorage.setItem('subcontractorData', JSON.stringify(data));
        }

        function loadData() {
            const saved = localStorage.getItem('subcontractorData');
            if (saved) {
                const data = JSON.parse(saved);
                sites = data.sites || sites;
                subcontractors = data.subcontractors || [];
                weeklyWork = data.weeklyWork || [];
                dayWorkRequests = data.dayWorkRequests || [];
            }
        }

        // Initialize
        function init() {
            loadData();
            updateSubcontractorSelect();
            showAccountSelection();
        }

        // Account Management
        function selectAccount(type) {
            if (type === 'admin') {
                currentUser = 'Admin';
                currentUserType = 'admin';
                showDashboard();
            }
        }

        function showSubcontractorLogin() {
            document.getElementById('subcontractorLoginModal').classList.remove('hidden');
        }

        function hideSubcontractorLogin() {
            document.getElementById('subcontractorLoginModal').classList.add('hidden');
        }

        function loginSubcontractor() {
            const select = document.getElementById('subcontractorSelect');
            const selectedId = select.value;
            
            if (!selectedId) {
                alert('Please select a subcontractor account');
                return;
            }
            
            const subcontractor = subcontractors.find(s => s.id == selectedId);
            currentUser = subcontractor.name;
            currentUserType = 'subcontractor';
            hideSubcontractorLogin();
            showDashboard();
        }

        function showCreateSubcontractor() {
            document.getElementById('createSubcontractorModal').classList.remove('hidden');
        }

        function hideCreateSubcontractor() {
            document.getElementById('createSubcontractorModal').classList.add('hidden');
            document.getElementById('newSubcontractorName').value = '';
            document.getElementById('newSubcontractorId').value = '';
        }

        function createSubcontractor() {
            const name = document.getElementById('newSubcontractorName').value.trim();
            const uniqueId = document.getElementById('newSubcontractorId').value.trim();
            
            if (!name || !uniqueId) {
                alert('Please fill in all fields');
                return;
            }
            
            if (subcontractors.some(s => s.uniqueId === uniqueId)) {
                alert('This ID already exists');
                return;
            }
            
            const newId = subcontractors.length > 0 ? Math.max(...subcontractors.map(s => s.id)) + 1 : 1;
            subcontractors.push({ id: newId, name, uniqueId });
            
            saveData();
            updateSubcontractorSelect();
            hideCreateSubcontractor();
            alert('Subcontractor account created successfully!');
        }

        function updateSubcontractorSelect() {
            const select = document.getElementById('subcontractorSelect');
            select.innerHTML = '<option value="">Select your account...</option>';
            
            subcontractors.forEach(sub => {
                const option = document.createElement('option');
                option.value = sub.id;
                option.textContent = `${sub.name} (${sub.uniqueId})`;
                select.appendChild(option);
            });
        }

        function logout() {
            currentUser = null;
            currentUserType = null;
            showAccountSelection();
        }

        // Navigation
        function showAccountSelection() {
            document.getElementById('accountSelection').classList.remove('hidden');
            document.getElementById('dashboard').classList.add('hidden');
        }

        function showDashboard() {
            document.getElementById('accountSelection').classList.add('hidden');
            document.getElementById('dashboard').classList.remove('hidden');
            document.getElementById('currentUser').textContent = `${currentUser} (${currentUserType})`;
            
            // Show/hide admin controls
            const adminControls = document.getElementById('adminSiteControls');
            const thisWeekTab = document.getElementById('thisWeekTabButton');
            const messagesTab = document.getElementById('messagesTabButton');
            
            if (currentUserType === 'admin') {
                adminControls.classList.remove('hidden');
                thisWeekTab.classList.add('hidden');
                messagesTab.classList.remove('hidden');
                updatePendingCount();
            } else {
                adminControls.classList.add('hidden');
                thisWeekTab.classList.remove('hidden');
                messagesTab.classList.add('hidden');
            }
            
            showTab('sites');
            renderSites();
        }

        function showTab(tabName) {
            // Hide all tabs
            document.getElementById('sitesTab').classList.add('hidden');
            document.getElementById('thisWeekTab').classList.add('hidden');
            document.getElementById('messagesTab').classList.add('hidden');
            
            // Show selected tab
            document.getElementById(tabName + 'Tab').classList.remove('hidden');
            
            // Update tab buttons
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.classList.remove('border-blue-500', 'primary-text');
                btn.classList.add('border-transparent');
            });
            
            event.target.classList.add('border-blue-500', 'primary-text');
            event.target.classList.remove('border-transparent');
            
            if (tabName === 'thisWeek') {
                renderWeeklyWork();
            } else if (tabName === 'messages') {
                renderDayWorkRequests();
            }
        }

        // Site Management
        function addSite() {
            const name = document.getElementById('newSiteName').value.trim();
            if (!name) {
                alert('Please enter a site name');
                return;
            }
            
            const newId = sites.length > 0 ? Math.max(...sites.map(s => s.id)) + 1 : 1;
            sites.push({
                id: newId,
                name: name,
                houseTypes: [],
                plots: []
            });
            
            document.getElementById('newSiteName').value = '';
            saveData();
            renderSites();
        }

        function deleteSite(siteId) {
            if (confirm('Are you sure you want to delete this site? This will remove all associated plots and house types.')) {
                sites = sites.filter(s => s.id !== siteId);
                saveData();
                renderSites();
            }
        }

        function renderSites() {
            const container = document.getElementById('sitesList');
            container.innerHTML = '';
            
            sites.forEach(site => {
                const siteCard = document.createElement('div');
                siteCard.className = 'ios-card p-6 fade-in';
                
                const activePlots = site.plots.filter(plot => {
                    return !plot.firstFixCompleted || !plot.secondFixCompleted || !plot.finalCompleted;
                }).length;
                
                siteCard.innerHTML = `
                    <div class="flex justify-between items-start mb-4">
                        <div>
                            <h3 class="text-xl font-bold primary-text">
                                <i class="fas fa-home mr-2"></i>${site.name}
                            </h3>
                            <p class="text-gray-600">
                                <i class="fas fa-map-marker-alt mr-1"></i>${activePlots} active plots
                            </p>
                        </div>
                        ${currentUserType === 'admin' ? `
                            <button onclick="deleteSite(${site.id})" class="ios-button bg-red-100 text-red-600 px-3 py-2">
                                <i class="fas fa-trash text-sm"></i>
                            </button>
                        ` : ''}
                    </div>
                    <button onclick="openSiteDetail(${site.id})" class="ios-button primary-bg text-white w-full py-3">
                        <i class="fas fa-eye mr-2"></i>View Site
                    </button>
                `;
                
                container.appendChild(siteCard);
            });
        }

        // Site Detail Management
        function openSiteDetail(siteId) {
            currentSite = sites.find(s => s.id === siteId);
            document.getElementById('siteDetailTitle').textContent = currentSite.name;
            
            // Show/hide admin controls
            const adminControls = document.getElementById('siteAdminControls');
            if (currentUserType === 'admin') {
                adminControls.classList.remove('hidden');
                updateHouseTypeSelect();
            } else {
                adminControls.classList.add('hidden');
            }
            
            document.getElementById('siteDetailModal').classList.remove('hidden');
            renderPlots();
        }

        function closeSiteDetail() {
            document.getElementById('siteDetailModal').classList.add('hidden');
            currentSite = null;
        }

        function addHouseType() {
            const name = document.getElementById('houseTypeName').value.trim();
            const firstFix = parseFloat(document.getElementById('firstFixPrice').value) || 0;
            const secondFix = parseFloat(document.getElementById('secondFixPrice').value) || 0;
            const final = parseFloat(document.getElementById('finalPrice').value) || 0;
            
            if (!name) {
                alert('Please enter a house type name');
                return;
            }
            
            const newId = currentSite.houseTypes.length > 0 ? 
                Math.max(...currentSite.houseTypes.map(h => h.id)) + 1 : 1;
            
            currentSite.houseTypes.push({
                id: newId,
                name: name,
                firstFix: firstFix,
                secondFix: secondFix,
                final: final
            });
            
            // Clear form
            document.getElementById('houseTypeName').value = '';
            document.getElementById('firstFixPrice').value = '';
            document.getElementById('secondFixPrice').value = '';
            document.getElementById('finalPrice').value = '';
            
            saveData();
            updateHouseTypeSelect();
            renderPlots();
        }

        function updateHouseTypeSelect() {
            const select = document.getElementById('plotHouseType');
            select.innerHTML = '<option value="">Select House Type</option>';
            
            currentSite.houseTypes.forEach(type => {
                const option = document.createElement('option');
                option.value = type.id;
                option.textContent = type.name;
                select.appendChild(option);
            });
        }

        function addPlot() {
            const plotNumber = document.getElementById('plotNumber').value.trim();
            const houseTypeId = parseInt(document.getElementById('plotHouseType').value);
            
            if (!plotNumber || !houseTypeId) {
                alert('Please fill in all fields');
                return;
            }
            
            if (currentSite.plots.some(p => p.number === plotNumber)) {
                alert('Plot number already exists');
                return;
            }
            
            const newId = currentSite.plots.length > 0 ? 
                Math.max(...currentSite.plots.map(p => p.id)) + 1 : 1;
            
            currentSite.plots.push({
                id: newId,
                number: plotNumber,
                houseTypeId: houseTypeId,
                firstFixCompleted: false,
                secondFixCompleted: false,
                finalCompleted: false,
                extras: [],
                completedBy: {}
            });
            
            document.getElementById('plotNumber').value = '';
            document.getElementById('plotHouseType').value = '';
            saveData();
            renderPlots();
        }

        function deletePlot(plotId) {
            if (confirm('Are you sure you want to delete this plot? This will remove all associated work and extras.')) {
                currentSite.plots = currentSite.plots.filter(p => p.id !== plotId);
                saveData();
                renderPlots();
            }
        }

        function renderPlots() {
            const container = document.getElementById('plotsGrid');
            container.innerHTML = '';
            
            // Filter out completed plots for non-admin users
            let plotsToShow = currentSite.plots;
            if (currentUserType !== 'admin') {
                plotsToShow = currentSite.plots.filter(plot => 
                    !plot.firstFixCompleted || !plot.secondFixCompleted || !plot.finalCompleted
                );
            }
            
            // Sort plots chronologically by plot number
            plotsToShow.sort((a, b) => {
                const numA = parseInt(a.number) || 0;
                const numB = parseInt(b.number) || 0;
                return numA - numB;
            });
            
            plotsToShow.forEach(plot => {
                const houseType = currentSite.houseTypes.find(h => h.id === plot.houseTypeId);
                if (!houseType) return;
                
                // Calculate total extras price
                const extrasTotal = plot.extras.reduce((sum, extra) => sum + (extra.price * extra.quantity), 0);
                const firstFixTotal = houseType.firstFix + extrasTotal;
                const secondFixTotal = houseType.secondFix + extrasTotal;
                
                const plotCard = document.createElement('div');
                plotCard.className = 'ios-card p-4';
                
                plotCard.innerHTML = `
                    <div class="flex justify-between items-start mb-3">
                        <div>
                            <h4 class="font-bold text-lg">
                                <i class="fas fa-map-pin mr-2 primary-text"></i>Plot ${plot.number}
                            </h4>
                            <p class="text-gray-600">
                                <i class="fas fa-home mr-1"></i>${houseType.name}
                            </p>
                        </div>
                        <div class="flex space-x-2">
                            <button onclick="showAddExtrasModal(${plot.id})" class="ios-button bg-gray-100 text-gray-800 px-3 py-2 text-sm">
                                <i class="fas fa-plus mr-1"></i>Extras
                            </button>
                            ${currentUserType === 'admin' ? `
                                <button onclick="deletePlot(${plot.id})" class="ios-button bg-red-100 text-red-600 px-3 py-2 text-sm">
                                    <i class="fas fa-trash"></i>
                                </button>
                            ` : ''}
                        </div>
                    </div>
                    
                    ${plot.extras.length > 0 ? `
                        <div class="mb-3 p-2 bg-blue-50 rounded-lg">
                            <p class="text-sm font-medium text-blue-800 mb-1">Extras:</p>
                            ${plot.extras.map(extra => `
                                <p class="text-xs text-blue-600">${extra.description} (${extra.quantity}x £${extra.price.toFixed(2)})</p>
                            `).join('')}
                        </div>
                    ` : ''}
                    
                    <div class="space-y-2">
                        <div class="flex justify-between items-center p-3 bg-gray-50 rounded-lg">
                            <span class="font-medium ${plot.firstFixCompleted ? 'completed' : ''}">
                                1st Fix
                            </span>
                            <div class="flex items-center space-x-2">
                                <span class="font-bold ${plot.firstFixCompleted ? 'completed' : ''}">£${firstFixTotal.toFixed(2)}</span>
                                ${plot.firstFixCompleted ? `
                                    <span class="text-xs text-green-600">
                                        <i class="fas fa-check mr-1"></i>${plot.completedBy.firstFix}
                                    </span>
                                ` : currentUserType === 'subcontractor' ? `
                                    <button onclick="claimWork(${plot.id}, 'firstFix', ${firstFixTotal})" class="ios-button primary-bg text-white px-3 py-2 text-xs">
                                        <i class="fas fa-hand-paper mr-1"></i>Claim
                                    </button>
                                ` : ''}
                            </div>
                        </div>
                        
                        <div class="flex justify-between items-center p-3 bg-gray-50 rounded-lg">
                            <span class="font-medium ${plot.secondFixCompleted ? 'completed' : ''}">
                                2nd Fix
                            </span>
                            <div class="flex items-center space-x-2">
                                <span class="font-bold ${plot.secondFixCompleted ? 'completed' : ''}">£${secondFixTotal.toFixed(2)}</span>
                                ${plot.secondFixCompleted ? `
                                    <span class="text-xs text-green-600">
                                        <i class="fas fa-check mr-1"></i>${plot.completedBy.secondFix}
                                    </span>
                                ` : currentUserType === 'subcontractor' ? `
                                    <button onclick="claimWork(${plot.id}, 'secondFix', ${secondFixTotal})" class="ios-button primary-bg text-white px-3 py-2 text-xs">
                                        <i class="fas fa-hand-paper mr-1"></i>Claim
                                    </button>
                                ` : ''}
                            </div>
                        </div>
                        
                        <div class="flex justify-between items-center p-3 bg-gray-50 rounded-lg">
                            <span class="font-medium ${plot.finalCompleted ? 'completed' : ''}">
                                Final
                            </span>
                            <div class="flex items-center space-x-2">
                                <span class="font-bold ${plot.finalCompleted ? 'completed' : ''}">£${houseType.final.toFixed(2)}</span>
                                ${plot.finalCompleted ? `
                                    <span class="text-xs text-green-600">
                                        <i class="fas fa-check mr-1"></i>${plot.completedBy.final}
                                    </span>
                                ` : currentUserType === 'subcontractor' ? `
                                    <button onclick="claimWork(${plot.id}, 'final', ${houseType.final})" class="ios-button primary-bg text-white px-3 py-2 text-xs">
                                        <i class="fas fa-hand-paper mr-1"></i>Claim
                                    </button>
                                ` : ''}
                            </div>
                        </div>
                    </div>
                `;
                
                container.appendChild(plotCard);
            });
        }

        // Extras Management
        function showAddExtrasModal(plotId) {
            currentPlot = currentSite.plots.find(p => p.id === plotId);
            document.getElementById('addExtrasModal').classList.remove('hidden');
        }

        function closeAddExtras() {
            document.getElementById('addExtrasModal').classList.add('hidden');
            document.getElementById('extraDescription').value = '';
            document.getElementById('extraQuantity').value = '1';
            document.getElementById('extraPrice').value = '7.50';
            currentPlot = null;
        }

        function addExtra() {
            const description = document.getElementById('extraDescription').value.trim();
            const quantity = parseInt(document.getElementById('extraQuantity').value) || 1;
            const price = parseFloat(document.getElementById('extraPrice').value) || 7.50;
            
            if (!description) {
                alert('Please enter a description');
                return;
            }
            
            currentPlot.extras.push({
                description: description,
                quantity: quantity,
                price: price
            });
            
            saveData();
            closeAddExtras();
            renderPlots();
        }

        // Work Claiming
        function claimWork(plotId, workType, amount) {
            const plot = currentSite.plots.find(p => p.id === plotId);
            
            if (workType === 'firstFix') {
                plot.firstFixCompleted = true;
                plot.completedBy.firstFix = currentUser;
            } else if (workType === 'secondFix') {
                plot.secondFixCompleted = true;
                plot.completedBy.secondFix = currentUser;
            } else if (workType === 'final') {
                plot.finalCompleted = true;
                plot.completedBy.final = currentUser;
            }
            
            // Add to weekly work for current subcontractor
            weeklyWork.push({
                subcontractor: currentUser,
                site: currentSite.name,
                plot: plot.number,
                workType: workType,
                amount: amount,
                date: new Date().toLocaleDateString()
            });
            
            saveData();
            renderPlots();
        }

        // Weekly Work Management
        function renderWeeklyWork() {
            const container = document.getElementById('weeklyWork');
            const totalElement = document.getElementById('weeklyTotal');
            
            container.innerHTML = '';
            let total = 0;
            
            // Filter work for current subcontractor
            const currentSubcontractorWork = weeklyWork.filter(work => work.subcontractor === currentUser);
            
            // Render claimed work
            currentSubcontractorWork.forEach((work, index) => {
                const workItem = document.createElement('div');
                workItem.className = 'flex justify-between items-center p-4 bg-green-50 rounded-lg border border-green-200';
                workItem.innerHTML = `
                    <div>
                        <p class="font-medium text-green-800">
                            <i class="fas fa-home mr-2"></i>${work.site} - Plot ${work.plot}
                        </p>
                        <p class="text-sm text-green-600">
                            <i class="fas fa-tools mr-2"></i>${work.workType} - ${work.date}
                        </p>
                    </div>
                    <span class="font-bold text-green-700 text-lg">£${work.amount.toFixed(2)}</span>
                `;
                container.appendChild(workItem);
                total += work.amount;
            });
            
            // Filter day work for current subcontractor
            const currentSubcontractorDayWork = dayWorkRequests.filter(dayWork => 
                dayWork.subcontractor === currentUser && dayWork.status === 'approved'
            );
            
            // Render day work requests
            currentSubcontractorDayWork.forEach((dayWork, index) => {
                const dayWorkItem = document.createElement('div');
                dayWorkItem.className = 'flex justify-between items-center p-4 bg-yellow-50 rounded-lg border border-yellow-200';
                const dayWorkTotal = dayWork.hours * dayWork.rate;
                dayWorkItem.innerHTML = `
                    <div>
                        <p class="font-medium text-yellow-800">
                            <i class="fas fa-clock mr-2"></i>Day Work - ${dayWork.hours}h @ £${dayWork.rate}/h
                        </p>
                        <p class="text-sm text-yellow-700">${dayWork.description}</p>
                        <p class="text-xs text-yellow-600">
                            <i class="fas fa-hourglass-half mr-1"></i>Pending admin approval
                        </p>
                    </div>
                    <span class="font-bold text-yellow-700 text-lg">£${dayWorkTotal.toFixed(2)}</span>
                `;
                container.appendChild(dayWorkItem);
                total += dayWorkTotal;
            });
            
            if (currentSubcontractorWork.length === 0 && currentSubcontractorDayWork.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-12">
                        <i class="fas fa-clipboard-list text-4xl text-gray-300 mb-4"></i>
                        <p class="text-gray-500 text-lg">No work claimed this week</p>
                        <p class="text-gray-400 text-sm mt-2">Claim work from the Sites tab or add day work above</p>
                    </div>
                `;
            }
            
            totalElement.textContent = total.toFixed(2);
        }

        // Day Work Management
        function showDayWorkModal() {
            document.getElementById('dayWorkModal').classList.remove('hidden');
        }

        function closeDayWork() {
            document.getElementById('dayWorkModal').classList.add('hidden');
            document.getElementById('dayWorkHours').value = '';
            document.getElementById('dayWorkRate').value = '';
            document.getElementById('dayWorkDescription').value = '';
        }

        function addDayWork() {
            const hours = parseFloat(document.getElementById('dayWorkHours').value);
            const rate = parseFloat(document.getElementById('dayWorkRate').value);
            const description = document.getElementById('dayWorkDescription').value.trim();
            
            if (!hours || !rate || !description) {
                alert('Please fill in all fields');
                return;
            }
            
            dayWorkRequests.push({
                subcontractor: currentUser,
                hours: hours,
                rate: rate,
                description: description,
                date: new Date().toLocaleDateString(),
                status: 'pending'
            });
            
            closeDayWork();
            saveData();
            alert('Day work submitted for admin approval');
            if (currentUserType === 'admin') {
                updatePendingCount();
            }
        }

        // Admin Day Work Management
        function renderDayWorkRequests() {
            const container = document.getElementById('dayWorkRequests');
            container.innerHTML = '';
            
            const pendingRequests = dayWorkRequests.filter(request => request.status === 'pending');
            
            if (pendingRequests.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-12">
                        <i class="fas fa-inbox text-4xl text-gray-300 mb-4"></i>
                        <p class="text-gray-500 text-lg">No pending day work requests</p>
                        <p class="text-gray-400 text-sm mt-2">Requests will appear here when subcontractors submit day work</p>
                    </div>
                `;
                return;
            }
            
            pendingRequests.forEach((request, index) => {
                const requestCard = document.createElement('div');
                requestCard.className = 'ios-card p-4 border-l-4 border-yellow-400';
                
                const total = request.hours * request.rate;
                
                requestCard.innerHTML = `
                    <div class="flex justify-between items-start mb-3">
                        <div>
                            <h4 class="font-bold text-lg">
                                <i class="fas fa-user mr-2 primary-text"></i>${request.subcontractor}
                            </h4>
                            <p class="text-gray-600">
                                <i class="fas fa-clock mr-1"></i>${request.hours} hours @ £${request.rate}/hour
                            </p>
                            <p class="text-gray-600">
                                <i class="fas fa-calendar mr-1"></i>Submitted: ${request.date}
                            </p>
                        </div>
                        <div class="text-right">
                            <p class="text-2xl font-bold primary-text">£${total.toFixed(2)}</p>
                            <p class="text-xs text-yellow-600">
                                <i class="fas fa-hourglass-half mr-1"></i>Pending
                            </p>
                        </div>
                    </div>
                    
                    <div class="mb-3 p-3 bg-gray-50 rounded-lg">
                        <p class="text-sm font-medium text-gray-700 mb-1">Work Description:</p>
                        <p class="text-gray-600">${request.description}</p>
                    </div>
                    
                    <div class="flex space-x-3">
                        <button onclick="approveDayWork(${index})" class="ios-button bg-green-100 text-green-700 flex-1 py-2">
                            <i class="fas fa-check mr-2"></i>Approve
                        </button>
                        <button onclick="denyDayWork(${index})" class="ios-button bg-red-100 text-red-700 flex-1 py-2">
                            <i class="fas fa-times mr-2"></i>Deny
                        </button>
                    </div>
                `;
                
                container.appendChild(requestCard);
            });
        }

        function approveDayWork(requestIndex) {
            const pendingRequests = dayWorkRequests.filter(request => request.status === 'pending');
            const request = pendingRequests[requestIndex];
            
            // Find the actual index in the full array
            const actualIndex = dayWorkRequests.findIndex(r => 
                r.subcontractor === request.subcontractor && 
                r.date === request.date && 
                r.description === request.description &&
                r.status === 'pending'
            );
            
            if (actualIndex !== -1) {
                dayWorkRequests[actualIndex].status = 'approved';
                saveData();
                renderDayWorkRequests();
                updatePendingCount();
                alert(`Day work approved for ${request.subcontractor}`);
            }
        }

        function denyDayWork(requestIndex) {
            const pendingRequests = dayWorkRequests.filter(request => request.status === 'pending');
            const request = pendingRequests[requestIndex];
            
            if (confirm(`Are you sure you want to deny this day work request from ${request.subcontractor}?`)) {
                // Find the actual index in the full array
                const actualIndex = dayWorkRequests.findIndex(r => 
                    r.subcontractor === request.subcontractor && 
                    r.date === request.date && 
                    r.description === request.description &&
                    r.status === 'pending'
                );
                
                if (actualIndex !== -1) {
                    dayWorkRequests[actualIndex].status = 'denied';
                    saveData();
                    renderDayWorkRequests();
                    updatePendingCount();
                    alert(`Day work denied for ${request.subcontractor}`);
                }
            }
        }

        function updatePendingCount() {
            const pendingCount = dayWorkRequests.filter(request => request.status === 'pending').length;
            const countElement = document.getElementById('pendingCount');
            
            if (pendingCount > 0) {
                countElement.textContent = pendingCount;
                countElement.classList.remove('hidden');
            } else {
                countElement.classList.add('hidden');
            }
        }

        // Initialize the application
        init();
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'967f901ff592af90',t:'MTc1Mzk5MDc3OS4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
