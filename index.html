<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Subcontractor Management System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary-blue: #0671e3;
        }
        
        .primary-bg { background-color: var(--primary-blue); }
        .primary-text { color: var(--primary-blue); }
        .primary-border { border-color: var(--primary-blue); }
        
        .ios-card {
            background: white;
            border-radius: 16px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            border: 1px solid rgba(0, 0, 0, 0.05);
            min-height: 120px;
        }
        
        .ios-button {
            border-radius: 12px;
            font-weight: 600;
            transition: all 0.2s ease;
            border: none;
            cursor: pointer;
        }
        
        .ios-button:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(6, 113, 227, 0.3);
        }
        
        .ios-input {
            border-radius: 12px;
            border: 1px solid #e5e7eb;
            padding: 12px 16px;
            font-size: 16px;
            transition: all 0.2s ease;
        }
        
        .ios-input:focus {
            outline: none;
            border-color: var(--primary-blue);
            box-shadow: 0 0 0 3px rgba(6, 113, 227, 0.1);
        }
        
        .completed {
            text-decoration: line-through;
            opacity: 0.6;
        }
        
        .fade-in {
            animation: fadeIn 0.3s ease-in;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- Account Selection Screen -->
    <div id="accountSelection" class="min-h-screen flex items-center justify-center p-4">
        <div class="ios-card p-8 w-full max-w-md text-center fade-in">
            <h1 class="text-3xl font-bold primary-text mb-8">Select Account Type</h1>
            
            <div class="space-y-4">
                <button onclick="selectAccount('admin')" class="ios-button primary-bg text-white w-full py-4 text-lg">
                    Admin Account
                </button>
                
                <button onclick="showSubcontractorLogin()" class="ios-button bg-gray-100 text-gray-800 w-full py-4 text-lg">
                    Subcontractor Account
                </button>
                
                <button onclick="showCreateSubcontractor()" class="ios-button border-2 primary-border primary-text w-full py-4 text-lg">
                    Create Subcontractor Account
                </button>
            </div>
        </div>
    </div>

    <!-- Create Subcontractor Modal -->
    <div id="createSubcontractorModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
        <div class="ios-card p-6 w-full max-w-md">
            <h2 class="text-2xl font-bold primary-text mb-6">Create Subcontractor Account</h2>
            <div class="space-y-4">
                <input type="text" id="newSubcontractorName" placeholder="Subcontractor Name" class="ios-input w-full">
                <input type="text" id="newSubcontractorId" placeholder="Unique ID" class="ios-input w-full">
                <div class="flex space-x-3">
                    <button onclick="createSubcontractor()" class="ios-button primary-bg text-white flex-1 py-3">Create</button>
                    <button onclick="hideCreateSubcontractor()" class="ios-button bg-gray-200 text-gray-800 flex-1 py-3">Cancel</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Subcontractor Login Modal -->
    <div id="subcontractorLoginModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
        <div class="ios-card p-6 w-full max-w-md">
            <h2 class="text-2xl font-bold primary-text mb-6">Subcontractor Login</h2>
            <div class="space-y-4">
                <select id="subcontractorSelect" class="ios-input w-full">
                    <option value="">Select your account...</option>
                </select>
                <div class="flex space-x-3">
                    <button onclick="loginSubcontractor()" class="ios-button primary-bg text-white flex-1 py-3">Login</button>
                    <button onclick="hideSubcontractorLogin()" class="ios-button bg-gray-200 text-gray-800 flex-1 py-3">Cancel</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Dashboard -->
    <div id="dashboard" class="hidden min-h-screen">
        <!-- Header -->
        <header class="primary-bg text-white p-4 shadow-lg">
            <div class="flex justify-between items-center max-w-6xl mx-auto">
                <h1 class="text-2xl font-bold">Subcontractor Management</h1>
                <div class="flex items-center space-x-4">
                    <span id="currentUser" class="text-sm opacity-90"></span>
                    <button onclick="logout()" class="ios-button bg-white bg-opacity-20 text-white px-4 py-2 text-sm">Logout</button>
                </div>
            </div>
        </header>

        <!-- Navigation Tabs -->
        <nav class="bg-white shadow-sm border-b">
            <div class="max-w-6xl mx-auto px-4">
                <div class="flex space-x-8">
                    <button onclick="showTab('sites')" class="tab-button py-4 px-2 border-b-2 border-transparent hover:border-blue-300 transition-colors">Sites</button>
                    <button id="thisWeekTabButton" onclick="showTab('thisWeek')" class="tab-button py-4 px-2 border-b-2 border-transparent hover:border-blue-300 transition-colors hidden">This Week</button>
                    <button id="messagesTabButton" onclick="showTab('messages')" class="tab-button py-4 px-2 border-b-2 border-transparent hover:border-blue-300 transition-colors hidden">
                        Messages <span id="pendingCount" class="bg-red-500 text-white text-xs px-2 py-1 rounded-full ml-2 hidden">0</span>
                    </button>
                    <button id="subcontractorMessagesTabButton" onclick="showTab('subcontractorMessages')" class="tab-button py-4 px-2 border-b-2 border-transparent hover:border-blue-300 transition-colors hidden">
                        Messages <span id="unreadCount" class="bg-red-500 text-white text-xs px-2 py-1 rounded-full ml-2 hidden">0</span>
                    </button>
                </div>
            </div>
        </nav>

        <!-- Sites Tab -->
        <div id="sitesTab" class="max-w-6xl mx-auto p-6">
            <!-- Admin Site Management -->
            <div id="adminSiteControls" class="hidden mb-8">
                <div class="ios-card p-6">
                    <h2 class="text-xl font-bold mb-4"><i class="fas fa-building mr-2 primary-text"></i>Site Management</h2>
                    <div class="flex space-x-4 mb-4">
                        <input type="text" id="newSiteName" placeholder="Site Name (e.g., Deer Park-Miller Homes)" class="ios-input flex-1">
                        <button onclick="addSite()" class="ios-button primary-bg text-white px-6 py-3">
                            <i class="fas fa-plus mr-2"></i>Add Site
                        </button>
                    </div>
                </div>
            </div>

            <!-- Sites List -->
            <div class="grid gap-6" id="sitesList">
                <!-- Sites will be populated here -->
            </div>
        </div>

        <!-- This Week Tab -->
        <div id="thisWeekTab" class="hidden max-w-6xl mx-auto p-6">
            <div class="ios-card p-6">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold">
                        <i class="fas fa-calendar-week mr-2 primary-text"></i>This Week's Work
                    </h2>
                    <button onclick="showDayWorkModal()" class="ios-button primary-bg text-white px-4 py-2">
                        <i class="fas fa-plus mr-2"></i>Add Day Work
                    </button>
                </div>
                
                <div id="weeklyWork" class="space-y-4 mb-6">
                    <!-- Weekly work items will appear here -->
                </div>
                
                <div class="border-t pt-4">
                    <div class="text-right">
                        <span class="text-lg font-bold primary-text">
                            <i class="fas fa-pound-sign mr-1"></i>Total This Week: Â£<span id="weeklyTotal">0.00</span>
                        </span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Messages Tab (Admin Only) -->
        <div id="messagesTab" class="hidden max-w-6xl mx-auto p-6">
            <div class="ios-card p-6 mb-6">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold">
                        <i class="fas fa-envelope mr-2 primary-text"></i>Day Work Requests
                    </h2>
                </div>
                
                <div id="dayWorkRequests" class="space-y-4">
                    <!-- Day work requests will appear here -->
                </div>
            </div>
            
            <div class="ios-card p-6">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold">
                        <i class="fas fa-paper-plane mr-2 primary-text"></i>Send Message to Subcontractor
                    </h2>
                </div>
                
                <div class="space-y-4">
                    <select id="messageRecipient" class="ios-input w-full">
                        <option value="">Select subcontractor...</option>
                    </select>
                    <input type="text" id="messageSubject" placeholder="Subject" class="ios-input w-full">
                    <textarea id="messageContent" placeholder="Message content" class="ios-input w-full h-32 resize-none"></textarea>
                    <button onclick="sendMessage()" class="ios-button primary-bg text-white px-6 py-3">
                        <i class="fas fa-send mr-2"></i>Send Message
                    </button>
                </div>
            </div>
        </div>

        <!-- Subcontractor Messages Tab -->
        <div id="subcontractorMessagesTab" class="hidden max-w-6xl mx-auto p-6">
            <div class="ios-card p-6">
                <h2 class="text-2xl font-bold mb-6">
                    <i class="fas fa-inbox mr-2 primary-text"></i>Messages
                </h2>
                
                <div id="subcontractorMessages" class="space-y-4">
                    <!-- Messages will appear here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Site Detail Modal -->
    <div id="siteDetailModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
        <div class="ios-card p-6 w-full max-w-4xl max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-6">
                <h2 id="siteDetailTitle" class="text-2xl font-bold primary-text"></h2>
                <button onclick="closeSiteDetail()" class="ios-button bg-gray-200 text-gray-800 px-4 py-2">Close</button>
            </div>
            
            <!-- Admin Controls -->
            <div id="siteAdminControls" class="hidden mb-6 space-y-4">
                <!-- House Types -->
                <div class="ios-card p-4">
                    <h3 class="font-bold mb-3">
                        <i class="fas fa-home-lg-alt mr-2 primary-text"></i>House Types
                    </h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                        <input type="text" id="houseTypeName" placeholder="House Type Name" class="ios-input">
                        <input type="number" id="firstFixPrice" placeholder="1st Fix Price" class="ios-input">
                        <input type="number" id="secondFixPrice" placeholder="2nd Fix Price" class="ios-input">
                        <input type="number" id="finalPrice" placeholder="Final Price" class="ios-input">
                    </div>
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            <i class="fas fa-file-pdf mr-2"></i>Drawing Plans (PDF, Images)
                        </label>
                        <input type="file" id="houseTypeFile" accept=".pdf,.jpg,.jpeg,.png,.gif" class="ios-input w-full" multiple>
                        <p class="text-xs text-gray-500 mt-1">Upload drawing plans, specifications, or reference images</p>
                    </div>
                    <button onclick="addHouseType()" class="ios-button primary-bg text-white px-4 py-2">
                        <i class="fas fa-plus mr-2"></i>Add House Type
                    </button>
                </div>
                
                <!-- Add Plot -->
                <div class="ios-card p-4">
                    <h3 class="font-bold mb-3">
                        <i class="fas fa-map-marked-alt mr-2 primary-text"></i>Add Plot
                    </h3>
                    <div class="flex space-x-4 mb-4">
                        <input type="text" id="plotNumber" placeholder="Plot Number" class="ios-input">
                        <select id="plotHouseType" class="ios-input">
                            <option value="">Select House Type</option>
                        </select>
                        <button onclick="addPlot()" class="ios-button primary-bg text-white px-4 py-2">
                            <i class="fas fa-plus mr-2"></i>Add Plot
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Plots Grid -->
            <div id="plotsGrid" class="grid gap-4">
                <!-- Plots will be populated here -->
            </div>
        </div>
    </div>

    <!-- Add Extras Modal -->
    <div id="addExtrasModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
        <div class="ios-card p-6 w-full max-w-md">
            <h2 class="text-xl font-bold primary-text mb-4">Add Extras</h2>
            <div class="space-y-4">
                <input type="text" id="extraDescription" placeholder="Extra Description (e.g., 8x downlights)" class="ios-input w-full">
                <input type="number" id="extraQuantity" placeholder="Quantity" class="ios-input w-full" value="1">
                <input type="number" id="extraPrice" placeholder="Price per item" class="ios-input w-full" value="7.50" step="0.01">
                <div class="flex space-x-3">
                    <button onclick="addExtra()" class="ios-button primary-bg text-white flex-1 py-3">Add Extra</button>
                    <button onclick="closeAddExtras()" class="ios-button bg-gray-200 text-gray-800 flex-1 py-3">Cancel</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Day Work Modal -->
    <div id="dayWorkModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
        <div class="ios-card p-6 w-full max-w-md">
            <h2 class="text-xl font-bold primary-text mb-4">Add Day Work</h2>
            <div class="space-y-4">
                <input type="number" id="dayWorkHours" placeholder="Hours worked" class="ios-input w-full" step="0.5">
                <input type="number" id="dayWorkRate" placeholder="Hourly rate (Â£)" class="ios-input w-full" step="0.01">
                <textarea id="dayWorkDescription" placeholder="Description of work" class="ios-input w-full h-20 resize-none"></textarea>
                <div class="flex space-x-3">
                    <button onclick="addDayWork()" class="ios-button primary-bg text-white flex-1 py-3">Submit</button>
                    <button onclick="closeDayWork()" class="ios-button bg-gray-200 text-gray-800 flex-1 py-3">Cancel</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Plot Kit Modal -->
    <div id="plotKitModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
        <div class="ios-card p-6 w-full max-w-6xl max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold primary-text">
                    <i class="fas fa-toolbox mr-2"></i>Plot Kit Materials
                </h2>
                <button onclick="closePlotKit()" class="ios-button bg-gray-200 text-gray-800 px-4 py-2">Close</button>
            </div>
            
            <!-- Plot Selection -->
            <div class="mb-6 p-4 bg-blue-50 rounded-lg">
                <label class="block text-sm font-medium text-blue-800 mb-2">Select Plot Number:</label>
                <select id="plotKitPlotSelect" class="ios-input w-full max-w-xs">
                    <option value="">Select plot...</option>
                </select>
            </div>
            
            <!-- Materials List -->
            <div class="grid gap-4 mb-6" id="plotKitMaterials">
                <!-- Materials will be populated here -->
            </div>
            
            <!-- Add Extra Material -->
            <div class="ios-card p-4 mb-6 bg-green-50">
                <h3 class="font-bold mb-3 text-green-800">
                    <i class="fas fa-plus mr-2"></i>Add Extra Material
                </h3>
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                    <input type="text" id="extraMaterialName" placeholder="Material Name" class="ios-input">
                    <input type="number" id="extraMaterialQuantity" placeholder="Quantity" class="ios-input" value="0">
                    <select id="extraMaterialColour" class="ios-input">
                        <option value="White">White</option>
                        <option value="Black">Black</option>
                        <option value="Brushed Chrome">Brushed Chrome</option>
                        <option value="Polished Chrome">Polished Chrome</option>
                    </select>
                    <button onclick="addExtraMaterial()" class="ios-button bg-green-600 text-white px-4 py-2">
                        <i class="fas fa-plus mr-2"></i>Add
                    </button>
                </div>
            </div>
            
            <!-- Save Buttons -->
            <div class="flex justify-end space-x-3">
                <button onclick="exportPlotKitToPDF()" class="ios-button bg-green-600 text-white px-6 py-3">
                    <i class="fas fa-file-pdf mr-2"></i>Export PDF
                </button>
                <button onclick="savePlotKit()" class="ios-button primary-bg text-white px-6 py-3">
                    <i class="fas fa-save mr-2"></i>Save Plot Kit
                </button>
            </div>
        </div>
    </div>

    <script>
        // Global state
        let currentUser = null;
        let currentUserType = null;
        let currentSite = null;
        let currentPlot = null;
        
        // Data storage
        let sites = [
            {
                id: 1,
                name: 'Deer Park-Miller Homes',
                houseTypes: [
                    { id: 1, name: 'Fordwood', firstFix: 450, secondFix: 380, final: 120 }
                ],
                plots: [
                    { id: 1, number: '1', houseTypeId: 1, firstFixCompleted: false, secondFixCompleted: false, finalCompleted: false, extras: [], completedBy: {} }
                ]
            }
        ];
        
        let subcontractors = [];
        
        let weeklyWork = [];
        let dayWorkRequests = [];
        let messages = [];
        let plotKits = [];
        
        // Default materials list
        const defaultMaterials = [
            '1 Gang Switch',
            '2 Gang Switch',
            '3 Gang Switch',
            'Intermediate Switch',
            'Unswitched Single Socket',
            'Switched Double Socket',
            'Shaver Socket',
            'Switched Fused Spur',
            'Fan Isolator',
            '4" Fan',
            '1 Gang Grid Plate & 2G Yoke',
            '2 Gang Grid Plate & 2G Yoke',
            '3 Gang Grid Plate & 4G Yoke',
            '4 Gang Grid Plate & 4G Yoke',
            '6 Gang Grid Plate & 2x 4G Yoke',
            'DP Grid Switch (Rockers In Extras)',
            '2 Way Lighting Grid Switch',
            'Intermediate Lighting Grid Switch',
            'Fuse Grid Carrier',
            '45a Cooker Isolator Switch w/Neon',
            '45a Cooker Outlet Plate',
            '2 Gang Euro Plate',
            '4 Gang Euro Plate',
            'Euro Blank',
            'Coax Euro Module',
            'Cat 6 Euro Module',
            'Type F Euro Module',
            'BT Euro Module',
            'BT Slave Point',
            '1 Gang Blank Plate',
            '2 Gang Blank Plate',
            'Wago Wiring Centre',
            'Pendant',
            'Batten Holder',
            'Drum Fitting',
            'Downlight (Colour Required)',
            'GU10',
            'Lamps',
            'Smoke Detector',
            'Heat Detector',
            'Carbon Monoxide (Mains)',
            'Carbon Monoxide (Battery)',
            'MultiSmoke',
            'Ei450',
            'RadioLINK',
            'Doorbell Chime',
            'Doorbell Push',
            'Outside Light',
            'Outside Socket',
            'Clear Connection Box',
            'Wiska Box',
            'Consumer Unit',
            '32a RCBO',
            '20a RCBO',
            '32a MCB',
            '20a MCB',
            '16a MCB',
            '6a MCB',
            'Blank MCB',
            'EV Charger'
        ];

        // Local Storage Functions
        function saveData() {
            try {
                const data = {
                    sites: sites,
                    subcontractors: subcontractors,
                    weeklyWork: weeklyWork,
                    dayWorkRequests: dayWorkRequests,
                    messages: messages,
                    plotKits: plotKits
                };
                
                const dataString = JSON.stringify(data);
                
                // Check if data is too large for localStorage (roughly 5MB limit)
                if (dataString.length > 5000000) {
                    // Remove file data from house types to reduce size
                    const cleanedData = JSON.parse(JSON.stringify(data));
                    cleanedData.sites.forEach(site => {
                        site.houseTypes.forEach(houseType => {
                            if (houseType.files && houseType.files.length > 0) {
                                houseType.files = houseType.files.map(file => ({
                                    name: file.name,
                                    type: file.type,
                                    data: '[File too large for storage]'
                                }));
                            }
                        });
                    });
                    
                    localStorage.setItem('subcontractorData', JSON.stringify(cleanedData));
                    console.warn('File data was too large and has been removed from storage');
                } else {
                    localStorage.setItem('subcontractorData', dataString);
                }
            } catch (error) {
                console.error('Error saving data:', error);
                alert('Error saving data. Storage may be full. Try refreshing the page.');
            }
        }

        function loadData() {
            const saved = localStorage.getItem('subcontractorData');
            if (saved) {
                const data = JSON.parse(saved);
                sites = data.sites || sites;
                subcontractors = data.subcontractors || [];
                weeklyWork = data.weeklyWork || [];
                dayWorkRequests = data.dayWorkRequests || [];
                messages = data.messages || [];
                plotKits = data.plotKits || [];
            }
        }

        // Initialize
        function init() {
            loadData();
            updateSubcontractorSelect();
            showAccountSelection();
        }

        // Account Management
        function selectAccount(type) {
            if (type === 'admin') {
                currentUser = 'Admin';
                currentUserType = 'admin';
                showDashboard();
            }
        }

        function showSubcontractorLogin() {
            document.getElementById('subcontractorLoginModal').classList.remove('hidden');
        }

        function hideSubcontractorLogin() {
            document.getElementById('subcontractorLoginModal').classList.add('hidden');
        }

        function loginSubcontractor() {
            const select = document.getElementById('subcontractorSelect');
            const selectedId = select.value;
            
            if (!selectedId) {
                alert('Please select a subcontractor account');
                return;
            }
            
            const subcontractor = subcontractors.find(s => s.id == selectedId);
            currentUser = subcontractor.name;
            currentUserType = 'subcontractor';
            hideSubcontractorLogin();
            showDashboard();
        }

        function showCreateSubcontractor() {
            document.getElementById('createSubcontractorModal').classList.remove('hidden');
        }

        function hideCreateSubcontractor() {
            document.getElementById('createSubcontractorModal').classList.add('hidden');
            document.getElementById('newSubcontractorName').value = '';
            document.getElementById('newSubcontractorId').value = '';
        }

        function createSubcontractor() {
            const name = document.getElementById('newSubcontractorName').value.trim();
            const uniqueId = document.getElementById('newSubcontractorId').value.trim();
            
            if (!name || !uniqueId) {
                alert('Please fill in all fields');
                return;
            }
            
            if (subcontractors.some(s => s.uniqueId === uniqueId)) {
                alert('This ID already exists');
                return;
            }
            
            const newId = subcontractors.length > 0 ? Math.max(...subcontractors.map(s => s.id)) + 1 : 1;
            subcontractors.push({ id: newId, name, uniqueId });
            
            saveData();
            updateSubcontractorSelect();
            hideCreateSubcontractor();
            alert('Subcontractor account created successfully!');
        }

        function updateSubcontractorSelect() {
            const select = document.getElementById('subcontractorSelect');
            select.innerHTML = '<option value="">Select your account...</option>';
            
            subcontractors.forEach(sub => {
                const option = document.createElement('option');
                option.value = sub.id;
                option.textContent = `${sub.name} (${sub.uniqueId})`;
                select.appendChild(option);
            });
        }

        function logout() {
            currentUser = null;
            currentUserType = null;
            showAccountSelection();
        }

        // Navigation
        function showAccountSelection() {
            document.getElementById('accountSelection').classList.remove('hidden');
            document.getElementById('dashboard').classList.add('hidden');
        }

        function showDashboard() {
            document.getElementById('accountSelection').classList.add('hidden');
            document.getElementById('dashboard').classList.remove('hidden');
            document.getElementById('currentUser').textContent = `${currentUser} (${currentUserType})`;
            
            // Show/hide admin controls
            const adminControls = document.getElementById('adminSiteControls');
            const thisWeekTab = document.getElementById('thisWeekTabButton');
            const messagesTab = document.getElementById('messagesTabButton');
            const subcontractorMessagesTab = document.getElementById('subcontractorMessagesTabButton');
            
            if (currentUserType === 'admin') {
                adminControls.classList.remove('hidden');
                thisWeekTab.classList.add('hidden');
                messagesTab.classList.remove('hidden');
                subcontractorMessagesTab.classList.add('hidden');
                updatePendingCount();
                updateMessageRecipients();
            } else {
                adminControls.classList.add('hidden');
                thisWeekTab.classList.remove('hidden');
                messagesTab.classList.add('hidden');
                subcontractorMessagesTab.classList.remove('hidden');
                updateUnreadCount();
            }
            
            showTab('sites');
            renderSites();
        }

        function showTab(tabName) {
            // Hide all tabs
            document.getElementById('sitesTab').classList.add('hidden');
            document.getElementById('thisWeekTab').classList.add('hidden');
            document.getElementById('messagesTab').classList.add('hidden');
            document.getElementById('subcontractorMessagesTab').classList.add('hidden');
            
            // Show selected tab
            document.getElementById(tabName + 'Tab').classList.remove('hidden');
            
            // Update tab buttons
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.classList.remove('border-blue-500', 'primary-text');
                btn.classList.add('border-transparent');
            });
            
            event.target.classList.add('border-blue-500', 'primary-text');
            event.target.classList.remove('border-transparent');
            
            if (tabName === 'thisWeek') {
                renderWeeklyWork();
            } else if (tabName === 'messages') {
                renderDayWorkRequests();
            } else if (tabName === 'subcontractorMessages') {
                renderSubcontractorMessages();
                markMessagesAsRead();
            }
        }

        // Site Management
        function addSite() {
            const name = document.getElementById('newSiteName').value.trim();
            if (!name) {
                alert('Please enter a site name');
                return;
            }
            
            const newId = sites.length > 0 ? Math.max(...sites.map(s => s.id)) + 1 : 1;
            sites.push({
                id: newId,
                name: name,
                houseTypes: [],
                plots: []
            });
            
            document.getElementById('newSiteName').value = '';
            saveData();
            renderSites();
        }

        function deleteSite(siteId) {
            if (confirm('Are you sure you want to delete this site? This will remove all associated plots and house types.')) {
                sites = sites.filter(s => s.id !== siteId);
                saveData();
                renderSites();
            }
        }

        function renderSites() {
            const container = document.getElementById('sitesList');
            container.innerHTML = '';
            
            sites.forEach(site => {
                const siteCard = document.createElement('div');
                siteCard.className = 'ios-card p-6 fade-in';
                
                const activePlots = site.plots.filter(plot => {
                    return !plot.firstFixCompleted || !plot.secondFixCompleted || !plot.finalCompleted;
                }).length;
                
                siteCard.innerHTML = `
                    <div class="flex justify-between items-start mb-4">
                        <div>
                            <h3 class="text-xl font-bold primary-text">
                                <i class="fas fa-home mr-2"></i>${site.name}
                            </h3>
                            <p class="text-gray-600">
                                <i class="fas fa-map-marker-alt mr-1"></i>${activePlots} active plots
                            </p>
                        </div>
                        ${currentUserType === 'admin' ? `
                            <button onclick="deleteSite(${site.id})" class="ios-button bg-red-100 text-red-600 px-3 py-2">
                                <i class="fas fa-trash text-sm"></i>
                            </button>
                        ` : ''}
                    </div>
                    <button onclick="openSiteDetail(${site.id})" class="ios-button primary-bg text-white w-full py-3">
                        <i class="fas fa-eye mr-2"></i>View Site
                    </button>
                `;
                
                container.appendChild(siteCard);
            });
        }

        // Site Detail Management
        function openSiteDetail(siteId) {
            currentSite = sites.find(s => s.id === siteId);
            document.getElementById('siteDetailTitle').textContent = currentSite.name;
            
            // Show/hide admin controls
            const adminControls = document.getElementById('siteAdminControls');
            if (currentUserType === 'admin') {
                adminControls.classList.remove('hidden');
                updateHouseTypeSelect();
            } else {
                adminControls.classList.add('hidden');
            }
            
            document.getElementById('siteDetailModal').classList.remove('hidden');
            renderPlots();
        }

        function closeSiteDetail() {
            document.getElementById('siteDetailModal').classList.add('hidden');
            currentSite = null;
        }

        function addHouseType() {
            const name = document.getElementById('houseTypeName').value.trim();
            const firstFix = parseFloat(document.getElementById('firstFixPrice').value) || 0;
            const secondFix = parseFloat(document.getElementById('secondFixPrice').value) || 0;
            const final = parseFloat(document.getElementById('finalPrice').value) || 0;
            const fileInput = document.getElementById('houseTypeFile');
            
            if (!name) {
                alert('Please enter a house type name');
                return;
            }
            
            const newId = currentSite.houseTypes.length > 0 ? 
                Math.max(...currentSite.houseTypes.map(h => h.id)) + 1 : 1;
            
            // Handle file uploads with better error handling
            const files = [];
            let filesProcessed = 0;
            const totalFiles = fileInput.files.length;
            
            function saveHouseTypeWithFiles() {
                try {
                    currentSite.houseTypes.push({
                        id: newId,
                        name: name,
                        firstFix: firstFix,
                        secondFix: secondFix,
                        final: final,
                        files: files
                    });
                    
                    // Clear form
                    document.getElementById('houseTypeName').value = '';
                    document.getElementById('firstFixPrice').value = '';
                    document.getElementById('secondFixPrice').value = '';
                    document.getElementById('finalPrice').value = '';
                    document.getElementById('houseTypeFile').value = '';
                    
                    saveData();
                    updateHouseTypeSelect();
                    renderPlots();
                    alert('House type added successfully!');
                } catch (error) {
                    console.error('Error saving house type:', error);
                    alert('Error saving house type. Please try again without files or with smaller files.');
                }
            }
            
            if (totalFiles > 0) {
                // Check file sizes first (limit to 5MB per file)
                for (let i = 0; i < totalFiles; i++) {
                    if (fileInput.files[i].size > 5 * 1024 * 1024) {
                        alert('File size too large. Please use files smaller than 5MB.');
                        return;
                    }
                }
                
                for (let i = 0; i < totalFiles; i++) {
                    const file = fileInput.files[i];
                    const reader = new FileReader();
                    
                    reader.onload = function(e) {
                        try {
                            files.push({
                                name: file.name,
                                type: file.type,
                                data: e.target.result
                            });
                            filesProcessed++;
                            
                            // Only save when all files are processed
                            if (filesProcessed === totalFiles) {
                                saveHouseTypeWithFiles();
                            }
                        } catch (error) {
                            console.error('Error processing file:', error);
                            alert('Error processing files. Please try again with different files.');
                        }
                    };
                    
                    reader.onerror = function() {
                        alert('Error reading file. Please try again.');
                    };
                    
                    reader.readAsDataURL(file);
                }
            } else {
                saveHouseTypeWithFiles();
            }
        }

        function updateHouseTypeSelect() {
            const select = document.getElementById('plotHouseType');
            select.innerHTML = '<option value="">Select House Type</option>';
            
            currentSite.houseTypes.forEach(type => {
                const option = document.createElement('option');
                option.value = type.id;
                option.textContent = type.name;
                select.appendChild(option);
            });
        }

        function addPlot() {
            const plotNumber = document.getElementById('plotNumber').value.trim();
            const houseTypeId = parseInt(document.getElementById('plotHouseType').value);
            
            if (!plotNumber || !houseTypeId) {
                alert('Please fill in all fields');
                return;
            }
            
            if (currentSite.plots.some(p => p.number === plotNumber)) {
                alert('Plot number already exists');
                return;
            }
            
            const newId = currentSite.plots.length > 0 ? 
                Math.max(...currentSite.plots.map(p => p.id)) + 1 : 1;
            
            currentSite.plots.push({
                id: newId,
                number: plotNumber,
                houseTypeId: houseTypeId,
                firstFixCompleted: false,
                secondFixCompleted: false,
                finalCompleted: false,
                extras: [],
                completedBy: {}
            });
            
            document.getElementById('plotNumber').value = '';
            document.getElementById('plotHouseType').value = '';
            saveData();
            renderPlots();
        }

        function deletePlot(plotId) {
            if (confirm('Are you sure you want to delete this plot? This will remove all associated work and extras.')) {
                currentSite.plots = currentSite.plots.filter(p => p.id !== plotId);
                saveData();
                renderPlots();
            }
        }

        function renderPlots() {
            const container = document.getElementById('plotsGrid');
            container.innerHTML = '';
            
            // Filter out completed plots for non-admin users
            let plotsToShow = currentSite.plots;
            if (currentUserType !== 'admin') {
                plotsToShow = currentSite.plots.filter(plot => 
                    !plot.firstFixCompleted || !plot.secondFixCompleted || !plot.finalCompleted
                );
            }
            
            // Sort plots chronologically by plot number
            plotsToShow.sort((a, b) => {
                const numA = parseInt(a.number) || 0;
                const numB = parseInt(b.number) || 0;
                return numA - numB;
            });
            
            plotsToShow.forEach(plot => {
                const houseType = currentSite.houseTypes.find(h => h.id === plot.houseTypeId);
                if (!houseType) return;
                
                // Calculate total extras price
                const extrasTotal = plot.extras.reduce((sum, extra) => sum + (extra.price * extra.quantity), 0);
                const firstFixTotal = houseType.firstFix + extrasTotal;
                const secondFixTotal = houseType.secondFix + extrasTotal;
                
                const plotCard = document.createElement('div');
                plotCard.className = 'ios-card p-4';
                
                plotCard.innerHTML = `
                    <div class="flex justify-between items-start mb-3">
                        <div>
                            <h4 class="font-bold text-lg">
                                <i class="fas fa-map-pin mr-2 primary-text"></i>Plot ${plot.number}
                            </h4>
                            <p class="text-gray-600">
                                <i class="fas fa-home mr-1"></i>${houseType.name}
                            </p>
                            ${houseType.files && houseType.files.length > 0 ? `
                                <div class="mt-2">
                                    <p class="text-xs text-blue-600 mb-1">
                                        <i class="fas fa-file mr-1"></i>Drawing Plans:
                                    </p>
                                    <div class="flex flex-wrap gap-1">
                                        ${houseType.files.map(file => {
                                            if (file.data === '[File too large for storage]') {
                                                return `<span class="text-xs bg-gray-100 text-gray-500 px-2 py-1 rounded">
                                                    <i class="fas fa-exclamation-triangle mr-1"></i>${file.name} (unavailable)
                                                </span>`;
                                            } else {
                                                return `<a href="${file.data}" download="${file.name}" class="text-xs bg-blue-100 text-blue-700 px-2 py-1 rounded hover:bg-blue-200">
                                                    <i class="fas fa-download mr-1"></i>${file.name}
                                                </a>`;
                                            }
                                        }).join('')}
                                    </div>
                                </div>
                            ` : ''}
                        </div>
                        <div class="flex space-x-2">
                            <button onclick="showAddExtrasModal(${plot.id})" class="ios-button bg-gray-100 text-gray-800 px-3 py-2 text-sm">
                                <i class="fas fa-plus mr-1"></i>Extras
                            </button>
                            ${currentUserType === 'subcontractor' ? `
                                <button onclick="showPlotKitModal(${plot.id})" class="ios-button bg-blue-100 text-blue-800 px-3 py-2 text-sm">
                                    <i class="fas fa-toolbox mr-1"></i>Plot Kit
                                </button>
                            ` : ''}
                            ${currentUserType === 'admin' ? `
                                <button onclick="deletePlot(${plot.id})" class="ios-button bg-red-100 text-red-600 px-3 py-2 text-sm">
                                    <i class="fas fa-trash"></i>
                                </button>
                            ` : ''}
                        </div>
                    </div>
                    
                    ${plot.extras.length > 0 ? `
                        <div class="mb-3 p-2 bg-blue-50 rounded-lg">
                            <p class="text-sm font-medium text-blue-800 mb-1">Extras:</p>
                            ${plot.extras.map(extra => `
                                <p class="text-xs text-blue-600">${extra.description} (${extra.quantity}x Â£${extra.price.toFixed(2)})</p>
                            `).join('')}
                        </div>
                    ` : ''}
                    
                    <div class="space-y-2">
                        <div class="flex justify-between items-center p-3 bg-gray-50 rounded-lg">
                            <span class="font-medium ${plot.firstFixCompleted ? 'completed' : ''}">
                                1st Fix
                            </span>
                            <div class="flex items-center space-x-2">
                                <span class="font-bold ${plot.firstFixCompleted ? 'completed' : ''}">Â£${firstFixTotal.toFixed(2)}</span>
                                ${plot.firstFixCompleted ? `
                                    <span class="text-xs text-green-600">
                                        <i class="fas fa-check mr-1"></i>${plot.completedBy.firstFix}
                                    </span>
                                ` : currentUserType === 'subcontractor' ? `
                                    <button onclick="claimWork(${plot.id}, 'firstFix', ${firstFixTotal})" class="ios-button primary-bg text-white px-3 py-2 text-xs">
                                        <i class="fas fa-hand-paper mr-1"></i>Claim
                                    </button>
                                ` : ''}
                            </div>
                        </div>
                        
                        <div class="flex justify-between items-center p-3 bg-gray-50 rounded-lg">
                            <span class="font-medium ${plot.secondFixCompleted ? 'completed' : ''}">
                                2nd Fix
                            </span>
                            <div class="flex items-center space-x-2">
                                <span class="font-bold ${plot.secondFixCompleted ? 'completed' : ''}">Â£${secondFixTotal.toFixed(2)}</span>
                                ${plot.secondFixCompleted ? `
                                    <span class="text-xs text-green-600">
                                        <i class="fas fa-check mr-1"></i>${plot.completedBy.secondFix}
                                    </span>
                                ` : currentUserType === 'subcontractor' ? `
                                    <button onclick="claimWork(${plot.id}, 'secondFix', ${secondFixTotal})" class="ios-button primary-bg text-white px-3 py-2 text-xs">
                                        <i class="fas fa-hand-paper mr-1"></i>Claim
                                    </button>
                                ` : ''}
                            </div>
                        </div>
                        
                        <div class="flex justify-between items-center p-3 bg-gray-50 rounded-lg">
                            <span class="font-medium ${plot.finalCompleted ? 'completed' : ''}">
                                Final
                            </span>
                            <div class="flex items-center space-x-2">
                                <span class="font-bold ${plot.finalCompleted ? 'completed' : ''}">Â£${houseType.final.toFixed(2)}</span>
                                ${plot.finalCompleted ? `
                                    <span class="text-xs text-green-600">
                                        <i class="fas fa-check mr-1"></i>${plot.completedBy.final}
                                    </span>
                                ` : currentUserType === 'subcontractor' ? `
                                    <button onclick="claimWork(${plot.id}, 'final', ${houseType.final})" class="ios-button primary-bg text-white px-3 py-2 text-xs">
                                        <i class="fas fa-hand-paper mr-1"></i>Claim
                                    </button>
                                ` : ''}
                            </div>
                        </div>
                    </div>
                `;
                
                container.appendChild(plotCard);
            });
        }

        // Extras Management
        function showAddExtrasModal(plotId) {
            currentPlot = currentSite.plots.find(p => p.id === plotId);
            document.getElementById('addExtrasModal').classList.remove('hidden');
        }

        function closeAddExtras() {
            document.getElementById('addExtrasModal').classList.add('hidden');
            document.getElementById('extraDescription').value = '';
            document.getElementById('extraQuantity').value = '1';
            document.getElementById('extraPrice').value = '7.50';
            currentPlot = null;
        }

        function addExtra() {
            const description = document.getElementById('extraDescription').value.trim();
            const quantity = parseInt(document.getElementById('extraQuantity').value) || 1;
            const price = parseFloat(document.getElementById('extraPrice').value) || 7.50;
            
            if (!description) {
                alert('Please enter a description');
                return;
            }
            
            if (!currentPlot) {
                alert('Error: No plot selected');
                return;
            }
            
            // Find the actual plot in the current site and update it
            const plotIndex = currentSite.plots.findIndex(p => p.id === currentPlot.id);
            if (plotIndex !== -1) {
                currentSite.plots[plotIndex].extras.push({
                    description: description,
                    quantity: quantity,
                    price: price
                });
                
                // Update the currentPlot reference
                currentPlot = currentSite.plots[plotIndex];
                
                saveData();
                closeAddExtras();
                renderPlots();
                alert('Extra added successfully!');
            } else {
                alert('Error: Could not find plot to update');
            }
        }

        // Work Claiming
        function claimWork(plotId, workType, amount) {
            const plot = currentSite.plots.find(p => p.id === plotId);
            
            if (workType === 'firstFix') {
                plot.firstFixCompleted = true;
                plot.completedBy.firstFix = currentUser;
            } else if (workType === 'secondFix') {
                plot.secondFixCompleted = true;
                plot.completedBy.secondFix = currentUser;
            } else if (workType === 'final') {
                plot.finalCompleted = true;
                plot.completedBy.final = currentUser;
            }
            
            // Add to weekly work for current subcontractor
            weeklyWork.push({
                subcontractor: currentUser,
                site: currentSite.name,
                plot: plot.number,
                workType: workType,
                amount: amount,
                date: new Date().toLocaleDateString(),
                week: getCurrentWeek()
            });
            
            saveData();
            renderPlots();
        }

        // Weekly Work Management
        function getWeekNumber(date) {
            const d = new Date(date);
            d.setHours(0, 0, 0, 0);
            d.setDate(d.getDate() + 3 - (d.getDay() + 6) % 7);
            const week1 = new Date(d.getFullYear(), 0, 4);
            return 1 + Math.round(((d.getTime() - week1.getTime()) / 86400000 - 3 + (week1.getDay() + 6) % 7) / 7);
        }

        function getCurrentWeek() {
            const now = new Date();
            return `${now.getFullYear()}-W${getWeekNumber(now)}`;
        }

        function renderWeeklyWork() {
            const container = document.getElementById('weeklyWork');
            const totalElement = document.getElementById('weeklyTotal');
            
            container.innerHTML = '';
            let total = 0;
            
            const currentWeek = getCurrentWeek();
            
            // Filter work for current subcontractor and current week only
            const currentSubcontractorWork = weeklyWork.filter(work => 
                work.subcontractor === currentUser && work.week === currentWeek
            );
            
            // Render claimed work
            currentSubcontractorWork.forEach((work, index) => {
                const workItem = document.createElement('div');
                workItem.className = 'flex justify-between items-center p-4 bg-green-50 rounded-lg border border-green-200';
                workItem.innerHTML = `
                    <div>
                        <p class="font-medium text-green-800">
                            <i class="fas fa-home mr-2"></i>${work.site} - Plot ${work.plot}
                        </p>
                        <p class="text-sm text-green-600">
                            <i class="fas fa-tools mr-2"></i>${work.workType} - ${work.date}
                        </p>
                    </div>
                    <span class="font-bold text-green-700 text-lg">Â£${work.amount.toFixed(2)}</span>
                `;
                container.appendChild(workItem);
                total += work.amount;
            });
            
            // Filter day work for current subcontractor
            const currentSubcontractorDayWork = dayWorkRequests.filter(dayWork => 
                dayWork.subcontractor === currentUser && dayWork.status === 'approved'
            );
            
            // Render day work requests
            currentSubcontractorDayWork.forEach((dayWork, index) => {
                const dayWorkItem = document.createElement('div');
                dayWorkItem.className = 'flex justify-between items-center p-4 bg-yellow-50 rounded-lg border border-yellow-200';
                const dayWorkTotal = dayWork.hours * dayWork.rate;
                dayWorkItem.innerHTML = `
                    <div>
                        <p class="font-medium text-yellow-800">
                            <i class="fas fa-clock mr-2"></i>Day Work - ${dayWork.hours}h @ Â£${dayWork.rate}/h
                        </p>
                        <p class="text-sm text-yellow-700">${dayWork.description}</p>
                        <p class="text-xs text-yellow-600">
                            <i class="fas fa-hourglass-half mr-1"></i>Pending admin approval
                        </p>
                    </div>
                    <span class="font-bold text-yellow-700 text-lg">Â£${dayWorkTotal.toFixed(2)}</span>
                `;
                container.appendChild(dayWorkItem);
                total += dayWorkTotal;
            });
            
            if (currentSubcontractorWork.length === 0 && currentSubcontractorDayWork.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-12">
                        <i class="fas fa-clipboard-list text-4xl text-gray-300 mb-4"></i>
                        <p class="text-gray-500 text-lg">No work claimed this week</p>
                        <p class="text-gray-400 text-sm mt-2">Claim work from the Sites tab or add day work above</p>
                    </div>
                `;
            }
            
            totalElement.textContent = total.toFixed(2);
        }

        // Day Work Management
        function showDayWorkModal() {
            document.getElementById('dayWorkModal').classList.remove('hidden');
        }

        function closeDayWork() {
            document.getElementById('dayWorkModal').classList.add('hidden');
            document.getElementById('dayWorkHours').value = '';
            document.getElementById('dayWorkRate').value = '';
            document.getElementById('dayWorkDescription').value = '';
        }

        function addDayWork() {
            const hours = parseFloat(document.getElementById('dayWorkHours').value);
            const rate = parseFloat(document.getElementById('dayWorkRate').value);
            const description = document.getElementById('dayWorkDescription').value.trim();
            
            if (!hours || !rate || !description) {
                alert('Please fill in all fields');
                return;
            }
            
            dayWorkRequests.push({
                subcontractor: currentUser,
                hours: hours,
                rate: rate,
                description: description,
                date: new Date().toLocaleDateString(),
                status: 'pending'
            });
            
            closeDayWork();
            saveData();
            alert('Day work submitted for admin approval');
            if (currentUserType === 'admin') {
                updatePendingCount();
            }
        }

        // Admin Day Work Management
        function renderDayWorkRequests() {
            const container = document.getElementById('dayWorkRequests');
            container.innerHTML = '';
            
            const pendingRequests = dayWorkRequests.filter(request => request.status === 'pending');
            
            if (pendingRequests.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-12">
                        <i class="fas fa-inbox text-4xl text-gray-300 mb-4"></i>
                        <p class="text-gray-500 text-lg">No pending day work requests</p>
                        <p class="text-gray-400 text-sm mt-2">Requests will appear here when subcontractors submit day work</p>
                    </div>
                `;
                return;
            }
            
            pendingRequests.forEach((request, index) => {
                const requestCard = document.createElement('div');
                requestCard.className = 'ios-card p-4 border-l-4 border-yellow-400';
                
                const total = request.hours * request.rate;
                
                requestCard.innerHTML = `
                    <div class="flex justify-between items-start mb-3">
                        <div>
                            <h4 class="font-bold text-lg">
                                <i class="fas fa-user mr-2 primary-text"></i>${request.subcontractor}
                            </h4>
                            <p class="text-gray-600">
                                <i class="fas fa-clock mr-1"></i>${request.hours} hours @ Â£${request.rate}/hour
                            </p>
                            <p class="text-gray-600">
                                <i class="fas fa-calendar mr-1"></i>Submitted: ${request.date}
                            </p>
                        </div>
                        <div class="text-right">
                            <p class="text-2xl font-bold primary-text">Â£${total.toFixed(2)}</p>
                            <p class="text-xs text-yellow-600">
                                <i class="fas fa-hourglass-half mr-1"></i>Pending
                            </p>
                        </div>
                    </div>
                    
                    <div class="mb-3 p-3 bg-gray-50 rounded-lg">
                        <p class="text-sm font-medium text-gray-700 mb-1">Work Description:</p>
                        <p class="text-gray-600">${request.description}</p>
                    </div>
                    
                    <div class="flex space-x-3">
                        <button onclick="approveDayWork(${index})" class="ios-button bg-green-100 text-green-700 flex-1 py-2">
                            <i class="fas fa-check mr-2"></i>Approve
                        </button>
                        <button onclick="denyDayWork(${index})" class="ios-button bg-red-100 text-red-700 flex-1 py-2">
                            <i class="fas fa-times mr-2"></i>Deny
                        </button>
                    </div>
                `;
                
                container.appendChild(requestCard);
            });
        }

        function approveDayWork(requestIndex) {
            const pendingRequests = dayWorkRequests.filter(request => request.status === 'pending');
            const request = pendingRequests[requestIndex];
            
            // Find the actual index in the full array
            const actualIndex = dayWorkRequests.findIndex(r => 
                r.subcontractor === request.subcontractor && 
                r.date === request.date && 
                r.description === request.description &&
                r.status === 'pending'
            );
            
            if (actualIndex !== -1) {
                dayWorkRequests[actualIndex].status = 'approved';
                saveData();
                renderDayWorkRequests();
                updatePendingCount();
                alert(`Day work approved for ${request.subcontractor}`);
            }
        }

        function denyDayWork(requestIndex) {
            const pendingRequests = dayWorkRequests.filter(request => request.status === 'pending');
            const request = pendingRequests[requestIndex];
            
            if (confirm(`Are you sure you want to deny this day work request from ${request.subcontractor}?`)) {
                // Find the actual index in the full array
                const actualIndex = dayWorkRequests.findIndex(r => 
                    r.subcontractor === request.subcontractor && 
                    r.date === request.date && 
                    r.description === request.description &&
                    r.status === 'pending'
                );
                
                if (actualIndex !== -1) {
                    dayWorkRequests[actualIndex].status = 'denied';
                    saveData();
                    renderDayWorkRequests();
                    updatePendingCount();
                    alert(`Day work denied for ${request.subcontractor}`);
                }
            }
        }

        function updatePendingCount() {
            const pendingCount = dayWorkRequests.filter(request => request.status === 'pending').length;
            const countElement = document.getElementById('pendingCount');
            
            if (pendingCount > 0) {
                countElement.textContent = pendingCount;
                countElement.classList.remove('hidden');
            } else {
                countElement.classList.add('hidden');
            }
        }

        // Message Management
        function updateMessageRecipients() {
            const select = document.getElementById('messageRecipient');
            select.innerHTML = '<option value="">Select subcontractor...</option>';
            
            subcontractors.forEach(sub => {
                const option = document.createElement('option');
                option.value = sub.name;
                option.textContent = `${sub.name} (${sub.uniqueId})`;
                select.appendChild(option);
            });
        }

        function sendMessage() {
            const recipient = document.getElementById('messageRecipient').value;
            const subject = document.getElementById('messageSubject').value.trim();
            const content = document.getElementById('messageContent').value.trim();
            
            if (!recipient || !subject || !content) {
                alert('Please fill in all fields');
                return;
            }
            
            messages.push({
                id: messages.length + 1,
                from: 'Admin',
                to: recipient,
                subject: subject,
                content: content,
                date: new Date().toLocaleDateString(),
                time: new Date().toLocaleTimeString(),
                read: false
            });
            
            // Clear form
            document.getElementById('messageRecipient').value = '';
            document.getElementById('messageSubject').value = '';
            document.getElementById('messageContent').value = '';
            
            saveData();
            alert(`Message sent to ${recipient}`);
        }

        function renderSubcontractorMessages() {
            const container = document.getElementById('subcontractorMessages');
            container.innerHTML = '';
            
            const userMessages = messages.filter(msg => msg.to === currentUser);
            
            if (userMessages.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-12">
                        <i class="fas fa-inbox text-4xl text-gray-300 mb-4"></i>
                        <p class="text-gray-500 text-lg">No messages</p>
                        <p class="text-gray-400 text-sm mt-2">Messages from admin will appear here</p>
                    </div>
                `;
                return;
            }
            
            // Sort messages by date (newest first)
            userMessages.sort((a, b) => new Date(b.date + ' ' + b.time) - new Date(a.date + ' ' + a.time));
            
            userMessages.forEach(message => {
                const messageCard = document.createElement('div');
                messageCard.className = `ios-card p-4 ${!message.read ? 'border-l-4 border-blue-400 bg-blue-50' : ''}`;
                
                messageCard.innerHTML = `
                    <div class="flex justify-between items-start mb-3">
                        <div>
                            <h4 class="font-bold text-lg ${!message.read ? 'text-blue-800' : ''}">
                                <i class="fas fa-envelope mr-2"></i>${message.subject}
                            </h4>
                            <p class="text-sm text-gray-600">
                                <i class="fas fa-user mr-1"></i>From: ${message.from}
                            </p>
                            <p class="text-xs text-gray-500">
                                <i class="fas fa-clock mr-1"></i>${message.date} at ${message.time}
                            </p>
                        </div>
                        ${!message.read ? `
                            <span class="bg-blue-500 text-white text-xs px-2 py-1 rounded-full">
                                <i class="fas fa-circle mr-1"></i>New
                            </span>
                        ` : ''}
                    </div>
                    
                    <div class="p-3 bg-gray-50 rounded-lg">
                        <p class="text-gray-700 whitespace-pre-wrap">${message.content}</p>
                    </div>
                `;
                
                container.appendChild(messageCard);
            });
        }

        function markMessagesAsRead() {
            messages.forEach(message => {
                if (message.to === currentUser && !message.read) {
                    message.read = true;
                }
            });
            saveData();
            updateUnreadCount();
        }

        function updateUnreadCount() {
            const unreadCount = messages.filter(msg => msg.to === currentUser && !msg.read).length;
            const countElement = document.getElementById('unreadCount');
            
            if (unreadCount > 0) {
                countElement.textContent = unreadCount;
                countElement.classList.remove('hidden');
            } else {
                countElement.classList.add('hidden');
            }
        }

        // Plot Kit Management
        function showPlotKitModal(plotId) {
            currentPlot = currentSite.plots.find(p => p.id === plotId);
            
            // Populate plot selection dropdown
            const plotSelect = document.getElementById('plotKitPlotSelect');
            plotSelect.innerHTML = '<option value="">Select plot...</option>';
            
            currentSite.plots.forEach(plot => {
                const option = document.createElement('option');
                option.value = plot.id;
                option.textContent = `Plot ${plot.number}`;
                if (plot.id === plotId) {
                    option.selected = true;
                }
                plotSelect.appendChild(option);
            });
            
            document.getElementById('plotKitModal').classList.remove('hidden');
            renderPlotKitMaterials();
        }

        function closePlotKit() {
            document.getElementById('plotKitModal').classList.add('hidden');
            currentPlot = null;
        }

        function renderPlotKitMaterials() {
            const container = document.getElementById('plotKitMaterials');
            container.innerHTML = '';
            
            const selectedPlotId = document.getElementById('plotKitPlotSelect').value;
            if (!selectedPlotId) return;
            
            // Find existing plot kit or create new one
            let plotKit = plotKits.find(pk => pk.plotId == selectedPlotId && pk.siteId === currentSite.id);
            if (!plotKit) {
                plotKit = {
                    id: plotKits.length + 1,
                    plotId: parseInt(selectedPlotId),
                    siteId: currentSite.id,
                    materials: defaultMaterials.map(material => ({
                        name: material,
                        quantity: 0,
                        colour: 'White'
                    })),
                    extraMaterials: []
                };
            }
            
            // Render default materials
            plotKit.materials.forEach((material, index) => {
                const materialCard = document.createElement('div');
                materialCard.className = 'ios-card p-4 grid grid-cols-1 md:grid-cols-4 gap-4 items-center';
                
                materialCard.innerHTML = `
                    <div class="font-medium text-gray-800">${material.name}</div>
                    <input type="number" value="${material.quantity}" onchange="updateMaterialQuantity(${index}, this.value, false)" class="ios-input" min="0">
                    <select onchange="updateMaterialColour(${index}, this.value, false)" class="ios-input">
                        <option value="White" ${material.colour === 'White' ? 'selected' : ''}>White</option>
                        <option value="Black" ${material.colour === 'Black' ? 'selected' : ''}>Black</option>
                        <option value="Brushed Chrome" ${material.colour === 'Brushed Chrome' ? 'selected' : ''}>Brushed Chrome</option>
                        <option value="Polished Chrome" ${material.colour === 'Polished Chrome' ? 'selected' : ''}>Polished Chrome</option>
                    </select>
                    <button onclick="deleteMaterial(${index}, false)" class="text-red-500 hover:text-red-700 p-1 rounded transition-colors" title="Delete material">
                        <i class="fas fa-times text-sm"></i>
                    </button>
                `;
                
                container.appendChild(materialCard);
            });
            
            // Render extra materials
            plotKit.extraMaterials.forEach((material, index) => {
                const materialCard = document.createElement('div');
                materialCard.className = 'ios-card p-4 grid grid-cols-1 md:grid-cols-4 gap-4 items-center bg-green-50';
                
                materialCard.innerHTML = `
                    <div class="font-medium text-green-800">
                        <i class="fas fa-plus mr-2"></i>${material.name}
                    </div>
                    <input type="number" value="${material.quantity}" onchange="updateMaterialQuantity(${index}, this.value, true)" class="ios-input" min="0">
                    <select onchange="updateMaterialColour(${index}, this.value, true)" class="ios-input">
                        <option value="White" ${material.colour === 'White' ? 'selected' : ''}>White</option>
                        <option value="Black" ${material.colour === 'Black' ? 'selected' : ''}>Black</option>
                        <option value="Brushed Chrome" ${material.colour === 'Brushed Chrome' ? 'selected' : ''}>Brushed Chrome</option>
                        <option value="Polished Chrome" ${material.colour === 'Polished Chrome' ? 'selected' : ''}>Polished Chrome</option>
                    </select>
                    <button onclick="deleteMaterial(${index}, true)" class="text-red-500 hover:text-red-700 p-1 rounded transition-colors" title="Delete material">
                        <i class="fas fa-times text-sm"></i>
                    </button>
                `;
                
                container.appendChild(materialCard);
            });
            
            // Store current plot kit for updates
            window.currentPlotKit = plotKit;
        }

        function updateMaterialQuantity(index, quantity, isExtra) {
            if (!window.currentPlotKit) return;
            
            const materials = isExtra ? window.currentPlotKit.extraMaterials : window.currentPlotKit.materials;
            if (materials[index]) {
                materials[index].quantity = parseInt(quantity) || 0;
            }
        }

        function updateMaterialColour(index, colour, isExtra) {
            if (!window.currentPlotKit) return;
            
            const materials = isExtra ? window.currentPlotKit.extraMaterials : window.currentPlotKit.materials;
            if (materials[index]) {
                materials[index].colour = colour || 'White';
            }
        }

        function deleteMaterial(index, isExtra) {
            if (!window.currentPlotKit) return;
            
            if (isExtra) {
                window.currentPlotKit.extraMaterials.splice(index, 1);
            } else {
                // For default materials, actually delete them now
                window.currentPlotKit.materials.splice(index, 1);
            }
            
            renderPlotKitMaterials();
        }

        function addExtraMaterial() {
            const name = document.getElementById('extraMaterialName').value.trim();
            const quantity = parseInt(document.getElementById('extraMaterialQuantity').value) || 0;
            const colour = document.getElementById('extraMaterialColour').value.trim() || 'White';
            
            if (!name) {
                alert('Please enter a material name');
                return;
            }
            
            if (!window.currentPlotKit) {
                alert('Please select a plot first');
                return;
            }
            
            window.currentPlotKit.extraMaterials.push({
                name: name,
                quantity: quantity,
                colour: colour
            });
            
            // Clear form
            document.getElementById('extraMaterialName').value = '';
            document.getElementById('extraMaterialQuantity').value = '0';
            document.getElementById('extraMaterialColour').value = 'White';
            
            renderPlotKitMaterials();
        }

        function exportPlotKitToPDF() {
            if (!window.currentPlotKit) {
                alert('No plot kit to export');
                return;
            }
            
            const selectedPlotId = document.getElementById('plotKitPlotSelect').value;
            if (!selectedPlotId) {
                alert('Please select a plot');
                return;
            }
            
            const plot = currentSite.plots.find(p => p.id == selectedPlotId);
            if (!plot) {
                alert('Plot not found');
                return;
            }
            
            // Create PDF content
            let pdfContent = `PLOT KIT MATERIALS\n\n`;
            pdfContent += `Site: ${currentSite.name}\n`;
            pdfContent += `Plot: ${plot.number}\n`;
            pdfContent += `Date: ${new Date().toLocaleDateString()}\n`;
            pdfContent += `Generated by: ${currentUser}\n\n`;
            pdfContent += `${'='.repeat(50)}\n\n`;
            
            // Add materials with quantities > 0
            const materialsWithQuantity = window.currentPlotKit.materials.filter(m => m.quantity > 0);
            const extrasWithQuantity = window.currentPlotKit.extraMaterials.filter(m => m.quantity > 0);
            
            if (materialsWithQuantity.length > 0) {
                pdfContent += `STANDARD MATERIALS:\n`;
                pdfContent += `${'='.repeat(30)}\n`;
                materialsWithQuantity.forEach(material => {
                    pdfContent += `${material.name.padEnd(35)} | Qty: ${material.quantity.toString().padStart(3)} | Color: ${material.colour}\n`;
                });
                pdfContent += `\n`;
            }
            
            if (extrasWithQuantity.length > 0) {
                pdfContent += `EXTRA MATERIALS:\n`;
                pdfContent += `${'='.repeat(30)}\n`;
                extrasWithQuantity.forEach(material => {
                    pdfContent += `${material.name.padEnd(35)} | Qty: ${material.quantity.toString().padStart(3)} | Color: ${material.colour}\n`;
                });
                pdfContent += `\n`;
            }
            
            if (materialsWithQuantity.length === 0 && extrasWithQuantity.length === 0) {
                pdfContent += `No materials with quantities specified.\n`;
            }
            
            pdfContent += `\n${'='.repeat(50)}\n`;
            pdfContent += `Total Items: ${materialsWithQuantity.length + extrasWithQuantity.length}\n`;
            pdfContent += `Total Quantity: ${[...materialsWithQuantity, ...extrasWithQuantity].reduce((sum, m) => sum + m.quantity, 0)}\n`;
            
            // Create and download the file
            const blob = new Blob([pdfContent], { type: 'text/plain' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `Plot_Kit_${currentSite.name.replace(/\s+/g, '_')}_Plot_${plot.number}_${new Date().toISOString().split('T')[0]}.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
            
            alert('Plot kit exported successfully! Note: Exported as text file due to browser limitations. You can convert to PDF using any text-to-PDF converter.');
        }

        function savePlotKit() {
            if (!window.currentPlotKit) {
                alert('No plot kit to save');
                return;
            }
            
            const selectedPlotId = document.getElementById('plotKitPlotSelect').value;
            if (!selectedPlotId) {
                alert('Please select a plot');
                return;
            }
            
            // Update plot ID in case it was changed
            window.currentPlotKit.plotId = parseInt(selectedPlotId);
            
            // Find existing plot kit or add new one
            const existingIndex = plotKits.findIndex(pk => 
                pk.plotId === window.currentPlotKit.plotId && pk.siteId === currentSite.id
            );
            
            if (existingIndex !== -1) {
                plotKits[existingIndex] = window.currentPlotKit;
            } else {
                plotKits.push(window.currentPlotKit);
            }
            
            saveData();
            closePlotKit();
            alert('Plot kit saved successfully!');
        }

        // Update plot selection change handler
        document.addEventListener('DOMContentLoaded', function() {
            const plotSelect = document.getElementById('plotKitPlotSelect');
            if (plotSelect) {
                plotSelect.addEventListener('change', function() {
                    renderPlotKitMaterials();
                });
            }
        });

        // Initialize the application
        init();
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'974eb84bc0f31ed8',t:'MTc1NjE2Mjk3Ni4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
